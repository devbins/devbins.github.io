<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>SystemServer - devbins blog</title>
  <meta name="renderer" content="webkit" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1"
/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec" />


<meta name="author" content="devbins" /><meta name="description" content="前言 在 Zygote 这篇文章中，我们提到 Zygote 会创建 SystemServer 进程，当时我们没有去了解。
今天就来聊一聊 SystemServer 。
" /><meta
  name="keywords"
  content="devbins, Emacs, ArchLinux"
/>


 


<meta
  name="generator"
  content="Hugo 0.113.0 with theme even"
/>


<link rel="canonical" href="http://devbins.github.io/post/systemserver/" />
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png"> <link rel="icon" type="image/png"
sizes="16x16" href="../../favicon-16x16.png"> <link rel="manifest"
href="../../manifest.json"> <link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">



<link href="../../sass/main.min.b874a8796a492f0d7c86bb24c33cbf052935783a5778ebaf819a8e514bf49f10.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
 <meta property="og:title" content="SystemServer" />
<meta property="og:description" content="前言
在 Zygote 这篇文章中，我们提到 Zygote 会创建 SystemServer 进程，当时我们没有去了解。
今天就来聊一聊 SystemServer 。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://devbins.github.io/post/systemserver/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-04-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-04-11T00:00:00+00:00" />
<meta itemprop="name" content="SystemServer">
<meta itemprop="description" content="前言
在 Zygote 这篇文章中，我们提到 Zygote 会创建 SystemServer 进程，当时我们没有去了解。
今天就来聊一聊 SystemServer 。"><meta itemprop="datePublished" content="2021-04-11T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-04-11T00:00:00+00:00" />
<meta itemprop="wordCount" content="4528">
<meta itemprop="keywords" content="Framework,SystemServer," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SystemServer"/>
<meta name="twitter:description" content="前言
在 Zygote 这篇文章中，我们提到 Zygote 会创建 SystemServer 进程，当时我们没有去了解。
今天就来聊一聊 SystemServer 。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script> <!
[endif]--> <!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script> <!
[endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="../../" class="logo">devbins</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="../../">
        <li class="mobile-menu-item">Home</li>
      </a><a href="../../post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="../../tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="../../categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="../../about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="../../" class="logo">devbins</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="../../">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">SystemServer</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-04-11 </span>
        <div class="post-category">
            <a href="../../categories/android/"> Android </a>
            </div>
          <span class="more-meta"> 约 4528 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#zygote">Zygote</a></li>
    <li><a href="#zygote-systemserver">Zygote -&gt; SystemServer</a>
      <ul>
        <li><a href="#forksystemserver">forkSystemServer</a></li>
        <li><a href="#nativeforksystemserver">nativeForkSystemServer</a></li>
      </ul>
    </li>
    <li><a href="#handlesystemserverprocess">handleSystemServerProcess</a>
      <ul>
        <li><a href="#performsystemserverdexopt">performSystemServerDexOpt</a></li>
        <li><a href="#zygoteinit">zygoteInit</a></li>
      </ul>
    </li>
    <li><a href="#小结-systemserver-创建过程">小结 SystemServer 创建过程</a></li>
    <li><a href="#systemserver-dot-main">SystemServer.main</a>
      <ul>
        <li><a href="#systemserver-dot-run">SystemServer.run</a></li>
        <li><a href="#createsystemcontext">createSystemContext</a></li>
        <li><a href="#startbootstrapservices">startBootstrapServices</a></li>
        <li><a href="#startcoreservices">startCoreServices</a></li>
        <li><a href="#startotherservices">startOtherServices</a></li>
        <li><a href="#服务启动阶段">服务启动阶段</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="前言">前言</h2>
<p>在 <a href="http://localhost:1313/post/zygote/">Zygote</a> 这篇文章中，我们提到 <code>Zygote</code> 会创建 <code>SystemServer</code> 进程，当时我们没有去了解。</p>
<p>今天就来聊一聊 <code>SystemServer</code> 。</p>
<h2 id="zygote">Zygote</h2>
<p>先来回顾一下 <code>Zygote</code> 启动 <code>SystemServer</code> 的代码在哪里
<code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">startSystemServer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建 SystemServer 进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">forkSystemServer</span><span class="o">(</span><span class="n">abiList</span><span class="o">,</span> <span class="n">zygoteSocketName</span><span class="o">,</span> <span class="n">zygoteServer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Accepting command socket connections&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>ZygoteInit</code> 的 <code>main</code> 方法中会调用 <code>forkSystemServer</code> ，所以我们要从这里入手，看看 <code>SystemServer</code> 是怎么启动的。</p>
<h2 id="zygote-systemserver">Zygote -&gt; SystemServer</h2>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">forkSystemServer</span><span class="o">(</span><span class="n">String</span> <span class="n">abiList</span><span class="o">,</span> <span class="n">String</span> <span class="n">socketName</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">ZygoteServer</span> <span class="n">zygoteServer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">args</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;--setuid=1000&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;--setgid=1000&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="s">&#34;1024,1032,1065,3001,3002,3003,3006,3007,3009,3010&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;--capabilities=&#34;</span> <span class="o">+</span> <span class="n">capabilities</span> <span class="o">+</span> <span class="s">&#34;,&#34;</span> <span class="o">+</span> <span class="n">capabilities</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;--nice-name=system_server&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;--runtime-args&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;--target-sdk-version=&#34;</span> <span class="o">+</span> <span class="n">VMRuntime</span><span class="o">.</span><span class="na">SDK_VERSION_CUR_DEVELOPMENT</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;com.android.server.SystemServer&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">ZygoteArguments</span> <span class="n">parsedArgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">parsedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZygoteArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Zygote</span><span class="o">.</span><span class="na">applyDebuggerSystemProperty</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Zygote</span><span class="o">.</span><span class="na">applyInvokeWithSystemProperty</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">profileSystemServer</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;dalvik.vm.profilesystemserver&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">profileSystemServer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRuntimeFlags</span> <span class="o">|=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">PROFILE_SYSTEM_SERVER</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// fork 子进程，uid=1000,gid=1000, 进程名=system_server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkSystemServer</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mGid</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mGids</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRuntimeFlags</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="kc">null</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPermittedCapabilities</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mEffectiveCapabilities</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 0 表示子进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 关闭从 Zygote 继承下来的 ServerSocket，因为用不到
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">zygoteServer</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">handleSystemServerProcess</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从 <code>args</code> 中，我们能看出来 <code>system server</code> 的 <code>uid=1000</code> ， <code>gid=1000</code> ，进程名为 <code>system_server</code> ，这里要注意最后一个参数 <code>com.android.server.SystemServer</code> 在后边会用到。</p>
<p>在参数准备好之后，会调用 <code>Zygote.forkSystemServer</code> 从而创建了 <code>SystemServer</code> 进程。跟进去看下是如何创建的</p>
<h3 id="forksystemserver">forkSystemServer</h3>
<p><code>/frameworks/base/core/java/com/android/internal/os/Zygote.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkSystemServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">runtimeFlags</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">long</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="kt">long</span> <span class="n">effectiveCapabilities</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ZygoteHooks</span><span class="o">.</span><span class="na">preFork</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">resetNicePriority</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkSystemServer</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="n">effectiveCapabilities</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Enable tracing as soon as we enter the system_server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Trace</span><span class="o">.</span><span class="na">setTracingEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">runtimeFlags</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ZygoteHooks</span><span class="o">.</span><span class="na">postForkCommon</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">nativeForkSystemServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">runtimeFlags</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">long</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="kt">long</span> <span class="n">effectiveCapabilities</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>forkSystemServer</code> 中通过 <code>JNI</code> 调用 <code>nativeForkSystemServer</code> 把 <code>fork</code> 任务交给了 <code>Native</code> 。</p>
<h3 id="nativeforksystemserver">nativeForkSystemServer</h3>
<p><code>/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">jint</span> <span class="nf">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">gids</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">jint</span> <span class="n">runtime_flags</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">rlimits</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">permitted_capabilities</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">jlong</span> <span class="n">effective_capabilities</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">ForkCommon</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">fds_to_close</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">fds_to_ignore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">SpecializeCommon</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gids</span><span class="p">,</span> <span class="n">runtime_flags</span><span class="p">,</span> <span class="n">rlimits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">permitted_capabilities</span><span class="p">,</span> <span class="n">effective_capabilities</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">MOUNT_EXTERNAL_DEFAULT</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="nb">false</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 父进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">gSystemServerPid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果 system server 死亡，重启 Zygote
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">)</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">RuntimeAbort</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="s">&#34;System server process has died. Restarting Zygote!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>nativeForkSystemServer</code> 中调用了 <code>ForkCommon</code> 创建子进程，然后在进程中调用 <code>SpecializeCommon</code> 。</p>
<p><code>Zygote</code> 进程会检测 <code>SystemServer</code> 是否死亡，如果死亡则重启 <code>Zygote</code> ，生死与共。</p>
<h4 id="forkcommon">ForkCommon</h4>
<p><code>/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">pid_t</span> <span class="nf">ForkCommon</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_system_server</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">fds_to_close</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">fds_to_ignore</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置 single 信号处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SetSignalHandlers</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">fail_fn</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">ZygoteFailure</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">is_system_server</span> <span class="o">?</span> <span class="s">&#34;system_server&#34;</span> <span class="o">:</span> <span class="s">&#34;zygote&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="k">nullptr</span><span class="p">,</span> <span class="n">_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BlockSignal</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">__android_log_close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">stats_log_close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">gOpenFdTable</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">gOpenFdTable</span> <span class="o">=</span> <span class="n">FileDescriptorTable</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">fds_to_ignore</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">gOpenFdTable</span><span class="o">-&gt;</span><span class="n">Restat</span><span class="p">(</span><span class="n">fds_to_ignore</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">android_fdsan_error_level</span> <span class="n">fdsan_error_level</span> <span class="o">=</span> <span class="n">android_fdsan_get_error_level</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建子进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">PreApplicationInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 关闭描述符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">DetachDescriptors</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">fds_to_close</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ClearUsapTable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">gOpenFdTable</span><span class="o">-&gt;</span><span class="n">ReopenOrDetach</span><span class="p">(</span><span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">android_fdsan_set_error_level</span><span class="p">(</span><span class="n">fdsan_error_level</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;Forked child process %d&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">UnblockSignal</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>ForkCommon</code> 进行了真正的 <code>fork</code> 创建了 <code>system server</code> 。</p>
<h4 id="specializecommon">SpecializeCommon</h4>
<p><code>/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">SpecializeCommon</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">gids</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">jint</span> <span class="n">runtime_flags</span><span class="p">,</span> <span class="n">jobjectArray</span> <span class="n">rlimits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">jlong</span> <span class="n">permitted_capabilities</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">effective_capabilities</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">jint</span> <span class="n">mount_external</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">managed_se_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">jstring</span> <span class="n">managed_nice_name</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_system_server</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="kt">bool</span> <span class="n">is_child_zygote</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">managed_instruction_set</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">jstring</span> <span class="n">managed_app_data_dir</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">process_name</span> <span class="o">=</span> <span class="n">is_system_server</span> <span class="o">?</span> <span class="s">&#34;system_server&#34;</span> <span class="o">:</span> <span class="s">&#34;zygote&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">SetInheritable</span><span class="p">(</span><span class="n">permitted_capabilities</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DropCapabilitiesBoundingSet</span><span class="p">(</span><span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">use_native_bridge</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_system_server</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                           <span class="n">instruction_set</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                           <span class="n">android</span><span class="o">::</span><span class="n">NativeBridgeAvailable</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                           <span class="n">android</span><span class="o">::</span><span class="n">NeedsNativeBridge</span><span class="p">(</span><span class="n">instruction_set</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">use_native_bridge</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">app_data_dir</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">use_native_bridge</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGW</span><span class="p">(</span><span class="s">&#34;Native bridge will not be used because managed_app_data_dir == nullptr.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">MountEmulatedStorage</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">mount_external</span><span class="p">,</span> <span class="n">use_native_bridge</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_system_server</span> <span class="o">&amp;&amp;</span> <span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 不是 system_server 的子进程，则创建进程组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">createProcessGroup</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 设置 group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">SetGids</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">gids</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 设置资源 limit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">SetRLimits</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">rlimits</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">SetCapabilities</span><span class="p">(</span><span class="n">permitted_capabilities</span><span class="p">,</span> <span class="n">effective_capabilities</span><span class="p">,</span> <span class="n">permitted_capabilities</span><span class="p">,</span> <span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 设置调度策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">SetSchedulerPolicy</span><span class="p">(</span><span class="n">fail_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">__android_log_close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">stats_log_close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">se_info_ptr</span> <span class="o">=</span> <span class="n">se_info</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">?</span> <span class="n">se_info</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span> <span class="o">:</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">nice_name_ptr</span> <span class="o">=</span> <span class="n">nice_name</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">?</span> <span class="n">nice_name</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span> <span class="o">:</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 设置 selinux 上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">selinux_android_setcontext</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">is_system_server</span><span class="p">,</span> <span class="n">se_info_ptr</span><span class="p">,</span> <span class="n">nice_name_ptr</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fail_fn</span><span class="p">(</span><span class="n">CREATE_ERROR</span><span class="p">(</span><span class="s">&#34;selinux_android_setcontext(%d, %d, </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">) failed&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">uid</span><span class="p">,</span> <span class="n">is_system_server</span><span class="p">,</span> <span class="n">se_info_ptr</span><span class="p">,</span> <span class="n">nice_name_ptr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">nice_name</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SetThreadName</span><span class="p">(</span><span class="n">nice_name</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_system_server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SetThreadName</span><span class="p">(</span><span class="s">&#34;system_server&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 把 signal 设置为默认函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">UnsetChldSignalHandler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">is_system_server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">gZygoteClass</span><span class="p">,</span> <span class="n">gCallPostForkSystemServerHooks</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fail_fn</span><span class="p">(</span><span class="s">&#34;Error calling post fork system server hooks.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">gZygoteInitClass</span><span class="p">,</span> <span class="n">gCreateSystemServerClassLoader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionClear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">kSystemServerLabel</span> <span class="o">=</span> <span class="s">&#34;u:r:system_server:s0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">selinux_android_setcon</span><span class="p">(</span><span class="n">kSystemServerLabel</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fail_fn</span><span class="p">(</span><span class="n">CREATE_ERROR</span><span class="p">(</span><span class="s">&#34;selinux_android_setcon(%s)&#34;</span><span class="p">,</span> <span class="n">kSystemServerLabel</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">gZygoteClass</span><span class="p">,</span> <span class="n">gCallPostForkChildHooks</span><span class="p">,</span> <span class="n">runtime_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">is_system_server</span><span class="p">,</span> <span class="n">is_child_zygote</span><span class="p">,</span> <span class="n">managed_instruction_set</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fail_fn</span><span class="p">(</span><span class="s">&#34;Error calling post fork hooks.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>System Server</code> 创建好了，就需要去处理自己的事情了，在文章开头中 <code>System Server</code> 创建好了之后，会调用 <code>handleSystemServerProcess</code> 去完成自己的使命。</p>
<h2 id="handlesystemserverprocess">handleSystemServerProcess</h2>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">handleSystemServerProcess</span><span class="o">(</span><span class="n">ZygoteArguments</span> <span class="n">parsedArgs</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// set umask to 0077 so new files and directories will default to owner-only permissions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Os</span><span class="o">.</span><span class="na">umask</span><span class="o">(</span><span class="n">S_IRWXG</span> <span class="o">|</span> <span class="n">S_IRWXO</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Process</span><span class="o">.</span><span class="na">setArgV0</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">String</span> <span class="n">systemServerClasspath</span> <span class="o">=</span> <span class="n">Os</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">&#34;SYSTEMSERVERCLASSPATH&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">systemServerClasspath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 优化 dex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">performSystemServerDexOpt</span><span class="o">(</span><span class="n">systemServerClasspath</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sCachedSystemServerClassLoader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">profileSystemServer</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;dalvik.vm.profilesystemserver&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">profileSystemServer</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">IS_USERDEBUG</span> <span class="o">||</span> <span class="n">Build</span><span class="o">.</span><span class="na">IS_ENG</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">prepareSystemServerProfile</span><span class="o">(</span><span class="n">systemServerClasspath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Failed to set up system server profile&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInvokeWith</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">systemServerClasspath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span><span class="o">[]</span> <span class="n">amendedArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">2</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">amendedArgs</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="s">&#34;-cp&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">amendedArgs</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">systemServerClasspath</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">amendedArgs</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span> <span class="o">=</span> <span class="n">amendedArgs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 启动应用进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">WrapperInit</span><span class="o">.</span><span class="na">execApplication</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInvokeWith</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getCurrentInstructionSet</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Unexpected return from WrapperInit.execApplication&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建类加载器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">createSystemServerClassLoader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">sCachedSystemServerClassLoader</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">cl</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// SystemServer 进入此分支
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span><span class="o">,</span> <span class="n">cl</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>handleSystemServerProcess</code> 会对 <code>dex</code> 进行优化， <code>systemServerClasspath</code> 环境变量主要有 <code>/system/framwork</code> 下的 <code>services.jar</code> 、 <code>ethernet-service.jar</code> 、 <code>wif-service.jar</code></p>
<p>然后创建类加载器，最后调用 <code>ZygoteInit.zygoteInit</code> 。</p>
<h3 id="performsystemserverdexopt">performSystemServerDexOpt</h3>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">performSystemServerDexOpt</span><span class="o">(</span><span class="n">String</span> <span class="n">classPath</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">classPathElements</span> <span class="o">=</span> <span class="n">classPath</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34;:&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">IInstalld</span> <span class="n">installd</span> <span class="o">=</span> <span class="n">IInstalld</span><span class="o">.</span><span class="na">Stub</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">ServiceManager</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="s">&#34;installd&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">String</span> <span class="n">instructionSet</span> <span class="o">=</span> <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">vmInstructionSet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">classPathForElement</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">compiledSomething</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">classPathElement</span> <span class="o">:</span> <span class="n">classPathElements</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">systemServerFilter</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;dalvik.vm.systemservercompilerfilter&#34;</span><span class="o">,</span> <span class="s">&#34;speed&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">dexoptNeeded</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dexoptNeeded</span> <span class="o">=</span> <span class="n">DexFile</span><span class="o">.</span><span class="na">getDexOptNeeded</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">classPathElement</span><span class="o">,</span> <span class="n">instructionSet</span><span class="o">,</span> <span class="n">systemServerFilter</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kc">null</span> <span class="cm">/* classLoaderContext */</span><span class="o">,</span> <span class="kc">false</span> <span class="cm">/* newProfile */</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                    <span class="kc">false</span> <span class="cm">/* downgrade */</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">dexoptNeeded</span> <span class="o">=</span> <span class="n">DexFile</span><span class="o">.</span><span class="na">NO_DEXOPT_NEEDED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">dexoptNeeded</span> <span class="o">!=</span> <span class="n">DexFile</span><span class="o">.</span><span class="na">NO_DEXOPT_NEEDED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">String</span> <span class="n">packageName</span> <span class="o">=</span> <span class="s">&#34;*&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">String</span> <span class="n">outputPath</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">dexFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">String</span> <span class="n">compilerFilter</span> <span class="o">=</span> <span class="n">systemServerFilter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">StorageManager</span><span class="o">.</span><span class="na">UUID_PRIVATE_INTERNAL</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">String</span> <span class="n">seInfo</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">String</span> <span class="n">classLoaderContext</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                    <span class="n">getSystemServerClassLoaderContext</span><span class="o">(</span><span class="n">classPathForElement</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="kt">int</span> <span class="n">targetSdkVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  <span class="c1">// SystemServer targets the system&#39;s SDK version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">installd</span><span class="o">.</span><span class="na">dexopt</span><span class="o">(</span><span class="n">classPathElement</span><span class="o">,</span> <span class="n">Process</span><span class="o">.</span><span class="na">SYSTEM_UID</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">instructionSet</span><span class="o">,</span> <span class="n">dexoptNeeded</span><span class="o">,</span> <span class="n">outputPath</span><span class="o">,</span> <span class="n">dexFlags</span><span class="o">,</span> <span class="n">compilerFilter</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">uuid</span><span class="o">,</span> <span class="n">classLoaderContext</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="kc">false</span> <span class="cm">/* downgrade */</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="cm">/*profileName*/</span> <span class="kc">null</span><span class="o">,</span> <span class="cm">/*dexMetadataPath*/</span> <span class="kc">null</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;server-dexopt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">compiledSomething</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="o">|</span> <span class="n">ServiceSpecificException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Failed compiling classpath element for system server: &#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">+</span> <span class="n">classPathElement</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">classPathForElement</span> <span class="o">=</span> <span class="n">encodeSystemServerClassPath</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">classPathForElement</span><span class="o">,</span> <span class="n">classPathElement</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">compiledSomething</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>socket</code> 通信将优化操作交给 <code>installed</code> 执行。</p>
<h3 id="zygoteinit">zygoteInit</h3>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Runnable</span> <span class="nf">zygoteInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">redirectLogStreams</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">commonInit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">nativeZygoteInit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">applicationInit</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">argv</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="commoninit">commonInit</h4>
<p><code>/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">commonInit</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LoggingHandler</span> <span class="n">loggingHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoggingHandler</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">RuntimeHooks</span><span class="o">.</span><span class="na">setUncaughtExceptionPreHandler</span><span class="o">(</span><span class="n">loggingHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置默认异常未捕获处理方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Thread</span><span class="o">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">KillApplicationHandler</span><span class="o">(</span><span class="n">loggingHandler</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置时区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RuntimeHooks</span><span class="o">.</span><span class="na">setTimeZoneIdSupplier</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;persist.sys.timezone&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogManager</span><span class="o">().</span><span class="na">reset</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">AndroidConfig</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置 http userAgent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">userAgent</span> <span class="o">=</span> <span class="n">getDefaultUserAgent</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&#34;http.agent&#34;</span><span class="o">,</span> <span class="n">userAgent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置 socket tag， 用于流量统计
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">NetworkManagementSocketTagger</span><span class="o">.</span><span class="na">install</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">initialized</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="nativezygoteinit">nativeZygoteInit</h4>
<p><code>/frameworks/base/core/jni/AndroidRuntime.cpp</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">com_android_internal_os_ZygoteInit_nativeZygoteInit</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">gCurRuntime</span><span class="o">-&gt;</span><span class="n">onZygoteInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>gCurRuntime</code> 是 <code>AppRuntime</code> 在 <code>Zygote</code> 中有提到。所以 <code>onZygoteInit</code> 其实是 <code>AppRuntime</code> 的方法，他在 <code>app_main.cpp</code> 中。
<code>/frameworks/base/cmds/app_process/app_main.cpp</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">virtual</span> <span class="kt">void</span> <span class="nf">onZygoteInit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sp</span><span class="o">&lt;</span><span class="n">ProcessState</span><span class="o">&gt;</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ALOGV</span><span class="p">(</span><span class="s">&#34;App process: starting thread pool.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc</span><span class="o">-&gt;</span><span class="n">startThreadPool</span><span class="p">();</span> <span class="c1">// 启动线程池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>onZygoteInit</code> 方法中，主要启动了线程池，熟悉 <code>Binder</code> 的应该不陌生，在 <code>ProcessState</code> 中会打开 <code>Binder</code> 驱动，并调用 <code>mmap</code> 进行内核空间地址的映射。</p>
<h4 id="applicationinit">applicationInit</h4>
<p><code>/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">nativeSetExitWithoutCleanup</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetHeapUtilization</span><span class="o">(</span><span class="mf">0.75f</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetSdkVersion</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Arguments</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">findStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的 <code>startClass</code> 是 <code>com.android.server.SystemServer</code> ，在文章开头中有提到过。</p>
<h4 id="findstaticmain">findStaticMain</h4>
<p><code>/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">findStaticMain</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Missing class when invoking static main &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">ex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Method</span> <span class="n">m</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;main&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Missing static main on &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SecurityException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Problem getting static main on &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span> <span class="o">(</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">isPublic</span><span class="o">(</span><span class="n">modifiers</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Main method is not public and static on &#34;</span> <span class="o">+</span> <span class="n">className</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查找 <code>com.android.server.SystemServer</code> 中的 <code>main</code> 方法。然后创建了 <code>MethodAndArgsCaller</code> ，它是个内部静态类。</p>
<h4 id="methodandargscaller">MethodAndArgsCaller</h4>
<p><code>/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodAndArgsCaller</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** method to call */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Method</span> <span class="n">mMethod</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** argument array */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">mArgs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">MethodAndArgsCaller</span><span class="o">(</span><span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mArgs</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">mArgs</span> <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">RuntimeException</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="o">(</span><span class="n">RuntimeException</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="k">instanceof</span> <span class="n">Error</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="o">(</span><span class="n">Error</span><span class="o">)</span> <span class="n">cause</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>MethodAndArgsCaller</code> 实现了 <code>Runnable</code> ，在 <code>run</code> 方法中，调用了上一步找到的 <code>main</code> 方法。但是我们并没有发现有地方调用了 <code>run</code> 方法。</p>
<p>我们往上走一路溯源到 <code>Zygote</code> 中，发现了 <code>run</code> 方法的调用，也就是文章的最开头。乍一看可能会以为是个线程，其实不是只是个普通调用。就像 <code>Handler</code> 中的 <code>Callback</code> 一样，都是普通方法调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ZygoteServer</span> <span class="n">zygoteServer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 通过 Socket 方式创建 ZygoteServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">zygoteServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZygoteServer</span><span class="o">(</span><span class="n">isPrimaryZygote</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">startSystemServer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建 SystemServer 进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">forkSystemServer</span><span class="o">(</span><span class="n">abiList</span><span class="o">,</span> <span class="n">zygoteSocketName</span><span class="o">,</span> <span class="n">zygoteServer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span> <span class="c1">// 调用 run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>run</code> 方法调用之后就进入到 <code>SystemServer.main</code> 方法中了。</p>
<h2 id="小结-systemserver-创建过程">小结 SystemServer 创建过程</h2>
<p>画个时序图小结一下 <code>SystemServer</code> 的创建过程</p>
<figure><img src="../../images/framework/system_server.png"/>
</figure>

<h2 id="systemserver-dot-main">SystemServer.main</h2>
<p><code>/frameworks/base/services/java/com/android/server/SystemServer.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">SystemServer</span><span class="o">().</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">SystemServer</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mFactoryTestMode</span> <span class="o">=</span> <span class="n">FactoryTest</span><span class="o">.</span><span class="na">getMode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mStartCount</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">SYSPROP_START_COUNT</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mRuntimeStartElapsedTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mRuntimeStartUptime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mRuntimeRestart</span> <span class="o">=</span> <span class="s">&#34;1&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;sys.boot_completed&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建了 <code>SystemServer</code> 构造方法没什么好说的，我们直接看 <code>run</code> 方法。</p>
<h3 id="systemserver-dot-run">SystemServer.run</h3>
<p><code>/frameworks/base/services/java/com/android/server/SystemServer.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置时间，最小是1970年，不能再早了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">EARLIEST_SUPPORTED_TIME</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;System clock is before 1970; setting to 1970.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SystemClock</span><span class="o">.</span><span class="na">setCurrentTimeMillis</span><span class="o">(</span><span class="n">EARLIEST_SUPPORTED_TIME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">timezoneProperty</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;persist.sys.timezone&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">timezoneProperty</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">timezoneProperty</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Timezone not set; setting to GMT.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;persist.sys.timezone&#34;</span><span class="o">,</span> <span class="s">&#34;GMT&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置语言
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;persist.sys.language&#34;</span><span class="o">).</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">String</span> <span class="n">languageTag</span> <span class="o">=</span> <span class="n">Locale</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">toLanguageTag</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;persist.sys.locale&#34;</span><span class="o">,</span> <span class="n">languageTag</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;persist.sys.language&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;persist.sys.country&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;persist.sys.localevar&#34;</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Binder</span><span class="o">.</span><span class="na">setWarnOnBlocking</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置虚拟机运行库路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&#34;persist.sys.dalvik.vm.lib.2&#34;</span><span class="o">,</span> <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">vmLibrary</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 清除内存上限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">clearGrowthLimit</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置内存有效利用率0.8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetHeapUtilization</span><span class="o">(</span><span class="mf">0.8f</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 确认指纹信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Build</span><span class="o">.</span><span class="na">ensureFingerprintProperty</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置环境变量前，指定用户
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Environment</span><span class="o">.</span><span class="na">setUserRequired</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">BaseBundle</span><span class="o">.</span><span class="na">setShouldDefuse</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Parcel</span><span class="o">.</span><span class="na">setStackTraceParceling</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置 Binder 优先级，确保在前台
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">BinderInternal</span><span class="o">.</span><span class="na">disableBackgroundScheduling</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">BinderInternal</span><span class="o">.</span><span class="na">setMaxThreads</span><span class="o">(</span><span class="n">sMaxBinderThreads</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_FOREGROUND</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setCanSelfBackground</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置当前线程为主线程，初始化Looper
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Looper</span><span class="o">.</span><span class="na">prepareMainLooper</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">().</span><span class="na">setSlowLogThresholdMs</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">SLOW_DISPATCH_THRESHOLD_MS</span><span class="o">,</span> <span class="n">SLOW_DELIVERY_THRESHOLD_MS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 加载android_servers.so，源码在frameworks/base/services
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;android_servers&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 检测上次关机是否失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">performPendingShutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建系统上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">createSystemContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 创建服务管理系统
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">mSystemServiceManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SystemServiceManager</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">setStartInfo</span><span class="o">(</span><span class="n">mRuntimeRestart</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">mRuntimeStartElapsedTime</span><span class="o">,</span> <span class="n">mRuntimeStartUptime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">LocalServices</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">SystemServiceManager</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">mSystemServiceManager</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Prepare the thread pool for init tasks that can be parallelized
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SystemServerInitThreadPool</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">traceEnd</span><span class="o">();</span>  <span class="c1">// InitBeforeStartServices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">traceBeginAndSlog</span><span class="o">(</span><span class="s">&#34;StartServices&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">startBootstrapServices</span><span class="o">();</span> <span class="c1">// 启动引导服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">startCoreServices</span><span class="o">();</span> <span class="c1">// 启动核心服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">startOtherServices</span><span class="o">();</span> <span class="c1">// 启动其他服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SystemServerInitThreadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">traceEnd</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Main thread loop unexpectedly exited&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>main</code> 方法中做的事有点多，比较复杂，大概有这么几个</p>
<ol>
<li>检测时间，比1970早，那就改成1970，不能比这个更早了。</li>
<li>设置语言</li>
<li>设置虚拟机运行库路径为 <code>persist.sys.dalvik.vm.lib.2</code></li>
<li>设置虚拟机参数，清除内存上限，设置利用率等</li>
<li>设置Binder 线程为前台优先级</li>
<li>创建Looper</li>
<li>加载 <code>libandroid_servers.so</code></li>
<li>检测上次关机是否失败</li>
<li>创建上下文</li>
<li>创建 <code>SystemServiceManager</code></li>
<li>启动引导服务、核心服务、其它服务</li>
<li>调用 Loop 开启循环</li>
</ol>
<h3 id="createsystemcontext">createSystemContext</h3>
<p><code>/frameworks/base/services/java/com/android/server/SystemServer.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">createSystemContext</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ActivityThread</span> <span class="n">activityThread</span> <span class="o">=</span> <span class="n">ActivityThread</span><span class="o">.</span><span class="na">systemMain</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemContext</span> <span class="o">=</span> <span class="n">activityThread</span><span class="o">.</span><span class="na">getSystemContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemContext</span><span class="o">.</span><span class="na">setTheme</span><span class="o">(</span><span class="n">DEFAULT_SYSTEM_THEME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Context</span> <span class="n">systemUiContext</span> <span class="o">=</span> <span class="n">activityThread</span><span class="o">.</span><span class="na">getSystemUiContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">systemUiContext</span><span class="o">.</span><span class="na">setTheme</span><span class="o">(</span><span class="n">DEFAULT_SYSTEM_THEME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="systemmain">systemMain</h4>
<p><code>/frameworks/base/core/java/android/app/ActivityThread.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ActivityThread</span> <span class="nf">systemMain</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ActivityThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">thread</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">thread</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">ActivityThread</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mResourcesManager</span> <span class="o">=</span> <span class="n">ResourcesManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>调用 <code>attatch</code> ，和普通应用的创建类似。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">attach</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">system</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startSeq</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sCurrentActivityThread</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemThread</span> <span class="o">=</span> <span class="n">system</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">system</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">android</span><span class="o">.</span><span class="na">ddm</span><span class="o">.</span><span class="na">DdmHandleAppName</span><span class="o">.</span><span class="na">setAppName</span><span class="o">(</span><span class="s">&#34;system_process&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">UserHandle</span><span class="o">.</span><span class="na">myUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">mInstrumentation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Instrumentation</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">basicInit</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">ContextImpl</span> <span class="n">context</span> <span class="o">=</span> <span class="n">ContextImpl</span><span class="o">.</span><span class="na">createAppContext</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">,</span> <span class="n">getSystemContext</span><span class="o">().</span><span class="na">mPackageInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">mInitialApplication</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">mPackageInfo</span><span class="o">.</span><span class="na">makeApplication</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">mInitialApplication</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;Unable to instantiate Application():&#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 <code>Instrumentation</code> 、 <code>ContextImpl</code> 、 <code>Application</code> 和应用进程创建类似。都是同一个套路，这样大家理解起来也容易。</p>
<h3 id="startbootstrapservices">startBootstrapServices</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startBootstrapServices</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 Watchdog ，尽可能早，如果在早期发生死锁，就让system server crash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">Watchdog</span> <span class="n">watchdog</span> <span class="o">=</span> <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">watchdog</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 等待 install 服务启动完成，以便它又机会创建适当权限的目录，比如 /data/user. 在其它服务初始化之前我们需要保证
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Installer</span> <span class="n">installer</span> <span class="o">=</span> <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">Installer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 DeviceIdentifiersPolicyService 在 ActivityManager 之前
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">DeviceIdentifiersPolicyService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 UriGrantsManagerService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">UriGrantsManagerService</span><span class="o">.</span><span class="na">Lifecycle</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动ActivityTaskManagerService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ActivityTaskManagerService</span> <span class="n">atm</span> <span class="o">=</span> <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">ActivityTaskManagerService</span><span class="o">.</span><span class="na">Lifecycle</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 ActivityManagerService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mActivityManagerService</span> <span class="o">=</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">Lifecycle</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">mSystemServiceManager</span><span class="o">,</span> <span class="n">atm</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">setSystemServiceManager</span><span class="o">(</span><span class="n">mSystemServiceManager</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">setInstaller</span><span class="o">(</span><span class="n">installer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mWindowManagerGlobalLock</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="na">getGlobalLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 PowerManagerService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mPowerManagerService</span> <span class="o">=</span> <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">PowerManagerService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">ThermalManagerService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">initPowerManagement</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 RecoverySystemService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">RecoverySystemService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">RescueParty</span><span class="o">.</span><span class="na">noteBoot</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 LightsService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">LightsService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&#34;config.enable_sidekick_graphics&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">WEAR_SIDEKICK_SERVICE_CLASS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 DisplayManagerService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mDisplayManagerService</span> <span class="o">=</span> <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">DisplayManagerService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startBootPhase</span><span class="o">(</span><span class="n">SystemService</span><span class="o">.</span><span class="na">PHASE_WAIT_FOR_DEFAULT_DISPLAY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">cryptState</span> <span class="o">=</span> <span class="n">VoldProperties</span><span class="o">.</span><span class="na">decrypt</span><span class="o">().</span><span class="na">orElse</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">ENCRYPTING_STATE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cryptState</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Detected encryption in progress - only parsing core apps&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">mOnlyCore</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ENCRYPTED_STATE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cryptState</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Device encrypted - only parsing core apps&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">mOnlyCore</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Start the package manager.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mRuntimeRestart</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MetricsLogger</span><span class="o">.</span><span class="na">histogram</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">&#34;boot_package_manager_init_start&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">mFirstBoot</span> <span class="o">=</span> <span class="n">mPackageManagerService</span><span class="o">.</span><span class="na">isFirstBoot</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mPackageManager</span> <span class="o">=</span> <span class="n">mSystemContext</span><span class="o">.</span><span class="na">getPackageManager</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 UserManagerService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">UserManagerService</span><span class="o">.</span><span class="na">LifeCycle</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">AttributeCache</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">setSystemProcess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">watchdog</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">,</span> <span class="n">mActivityManagerService</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mDisplayManagerService</span><span class="o">.</span><span class="na">setupSchedulerPolicies</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 OverlayManagerService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="k">new</span> <span class="n">OverlayManagerService</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">,</span> <span class="n">installer</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 SensorPrivacyService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="k">new</span> <span class="n">SensorPrivacyService</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&#34;persist.sys.displayinset.top&#34;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">updateSystemUiContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">LocalServices</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">DisplayManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">onOverlayChanged</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSensorServiceStart</span> <span class="o">=</span> <span class="n">SystemServerInitThreadPool</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TimingsTraceLog</span> <span class="n">traceLog</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TimingsTraceLog</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">SYSTEM_SERVER_TIMING_ASYNC_TAG</span><span class="o">,</span> <span class="n">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_SYSTEM_SERVER</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 启动 SensorService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">startSensorService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span> <span class="n">START_SENSOR_SERVICE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>startBootstrapServices</code> 中创建了许多服务，有这么几个 <code>ActivityManagerService</code> 、 <code>PowerManagerService</code> 、 <code>RecoverySystemService</code> 、 <code>LightsService</code> 、 <code>DisplayManagerService</code> 、 <code>UserManagerService</code> 、 <code>OverlayManagerService</code> 、 <code>SensorPrivacyService</code> 、 <code>SensorService</code></p>
<h3 id="startcoreservices">startCoreServices</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startCoreServices</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 BatteryService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">BatteryService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动 UsageStateService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">UsageStatsService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">setUsageStatsManager</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">LocalServices</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">UsageStatsManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">mPackageManager</span><span class="o">.</span><span class="na">hasSystemFeature</span><span class="o">(</span><span class="n">PackageManager</span><span class="o">.</span><span class="na">FEATURE_WEBVIEW</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 启动 WebViewUpdateService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">mWebViewUpdateService</span> <span class="o">=</span> <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">WebViewUpdateService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 记录设备状态的缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">CachedDeviceStateService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 记录 cpu 花在 binder 调用的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">BinderCallsStatsService</span><span class="o">.</span><span class="na">LifeCycle</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 用于记录 handle 处理所花费的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">LooperStatsService</span><span class="o">.</span><span class="na">Lifecycle</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 管理 APK 的回滚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">RollbackManagerService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 用于 bug report 的 BugreportManagerService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">BugreportManagerService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动用于 GPU 和 GPU 驱动的 GpuSerivce
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">GpuService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>startCoreServices</code> 中启动的服务比较少，主要的就 <code>BatteryService</code> 、 <code>UsageStateService</code> 、 <code>WebViewUpdateService</code></p>
<h3 id="startotherservices">startOtherServices</h3>
<p><code>startOtherServices</code> 太长了，这里精简了，留下重要的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startOtherServices</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">KeyChainSystemService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&#34;scheduling_policy&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SchedulingPolicyService</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">TelecomLoaderService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">telephonyRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TelephonyRegistry</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&#34;telephony.registry&#34;</span><span class="o">,</span> <span class="n">telephonyRegistry</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mEntropyMixer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EntropyMixer</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mContentResolver</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">ACCOUNT_SERVICE_CLASS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">CONTENT_SERVICE_CLASS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">installSystemProviders</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">DropBoxManagerService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vibrator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VibratorService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&#34;vibrator&#34;</span><span class="o">,</span> <span class="n">vibrator</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="k">new</span> <span class="n">AlarmManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">inputManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">wm</span> <span class="o">=</span> <span class="n">WindowManagerService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">inputManager</span><span class="o">,</span> <span class="o">!</span><span class="n">mFirstBoot</span><span class="o">,</span> <span class="n">mOnlyCore</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="k">new</span> <span class="n">PhoneWindowManager</span><span class="o">(),</span> <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">mActivityTaskManager</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">,</span> <span class="n">wm</span><span class="o">,</span> <span class="cm">/* allowIsolated= */</span> <span class="kc">false</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">DUMP_FLAG_PRIORITY_CRITICAL</span> <span class="o">|</span> <span class="n">DUMP_FLAG_PROTO</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INPUT_SERVICE</span><span class="o">,</span> <span class="n">inputManager</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                              <span class="kc">false</span><span class="o">,</span> <span class="n">DUMP_FLAG_PRIORITY_CRITICAL</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">setWindowManager</span><span class="o">(</span><span class="n">wm</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">wm</span><span class="o">.</span><span class="na">onInitReady</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">inputManager</span><span class="o">.</span><span class="na">setWindowManagerCallbacks</span><span class="o">(</span><span class="n">wm</span><span class="o">.</span><span class="na">getInputManagerCallback</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">inputManager</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">BluetoothService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">statusBar</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StatusBarManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wm</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">STATUS_BAR_SERVICE</span><span class="o">,</span> <span class="n">statusBar</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">networkStats</span> <span class="o">=</span> <span class="n">NetworkStatsService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">networkManagement</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NETWORK_STATS_SERVICE</span><span class="o">,</span> <span class="n">networkStats</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">NotificationManagerService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startBootPhase</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">SystemService</span><span class="o">.</span><span class="na">PHASE_THIRD_PARTY_APPS_CAN_START</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">AppBindingService</span><span class="o">.</span><span class="na">Lifecycle</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vibrator</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">lockSettings</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startBootPhase</span><span class="o">(</span><span class="n">SystemService</span><span class="o">.</span><span class="na">PHASE_LOCK_SETTINGS_READY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startBootPhase</span><span class="o">(</span><span class="n">SystemService</span><span class="o">.</span><span class="na">PHASE_SYSTEM_SERVICES_READY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mPowerManagerService</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(</span><span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">getAppOpsService</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">PermissionPolicyService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mPackageManagerService</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mDisplayManagerService</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(</span><span class="n">safeMode</span><span class="o">,</span> <span class="n">mOnlyCore</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startBootPhase</span><span class="o">(</span><span class="n">SystemService</span><span class="o">.</span><span class="na">PHASE_DEVICE_SPECIFIC_SERVICES_READY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mActivityManagerService</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="n">BOOT_TIMINGS_TRACE_LOG</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>startOtherServices</code> 方法太长了，这里精简了大部分，这里和前面的方法一样也是启动了许多服务，最后调用了 <code>AMS.systemReady</code> ，这里是 <code>AMS</code> 的启动过程。</p>
<p>经过这个方法 <code>SystemServer</code> 中要启动的服务都启动完了，接着调用 <code>loop</code> 进入循环，等待消息到来。</p>
<h3 id="服务启动阶段">服务启动阶段</h3>
<p>这里借用 <a href="http://gityuan.com/2016/02/20/android-system-server-2/">Android系统启动-SystemServer下篇 - Gityuan博客 | 袁辉辉的技术博客</a> 中的图片来展示服务启动阶段
<img src="../../images/framework/system_server_boot_phase.jpg" alt="">
详细的过程可以移步至 <a href="http://gityuan.com/2016/02/20/android-system-server-2/">Android系统启动-SystemServer下篇 - Gityuan博客 | 袁辉辉的技术博客</a> 中，写的很好了，我就不再重复了。</p>
<h2 id="总结">总结</h2>
<figure><img src="../../images/framework/system_server_main.png"/>
</figure>

<h2 id="参考">参考</h2>
<ul>
<li><a href="http://gityuan.com/2016/02/20/android-system-server-2/">Android系统启动-SystemServer下篇 - Gityuan博客 | 袁辉辉的技术博客</a></li>
<li><a href="https://www.jianshu.com/p/99e0b480666a">Android进程系列第四篇&mdash;SystemServer进程的启动流程 - 简书</a></li>
<li>《Android进阶解密》</li>
</ul>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">devbins</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-04-11
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="../../tags/framework/">Framework</a>
          <a href="../../tags/systemserver/">SystemServer</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="../../post/magit/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Magit 使用技巧</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="../../post/jni%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8/">
            <span class="next-text nav-default">JNI中的引用</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2021-04-11 00:00:00 \u002b0000 UTC',
        title: 'SystemServer',
        clientID: '1234e4dd9e0ad49470be',
        clientSecret: '9acb7351fca3dcca6d3cc50be8a1d2cf329f4163',
        repo: 'devbins.github.io',
        owner: 'devbins',
        admin: ['devbins'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a
    href="binshengh@gmail.com"
    class="iconfont icon-email"
    title="email"
  ></a>
  <a
    href="https://github.com/devbins"
    class="iconfont icon-github"
    title="github"
  ></a> 
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io"
      >Hugo</a
    > 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even"
      >Even</a
    >
  </span>

  

  <span class="copyright-year"> &copy; 2016 - 2023<span class="heart"><i class="iconfont icon-heart"></i></span
    ><span
      >devbins</span
    >
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="../../js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
