<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>LeakCanary 内存泄漏检测原理 - devbins blog</title>
  <meta name="renderer" content="webkit" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1"
/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec" />


<meta name="author" content="devbins" /><meta name="description" content="前言 内存泄漏是一个开发不得不面对的问题，在 Android 中有许多工具都可以用来检测内存泄漏，比如：MAT、Profile等。
但是这些工具都需要手动操作，比较麻烦，所以我们需要一个能够自动检测的工具，它就是LeakCanary。
今天就来了解一下原理，毕竟面试也是常问的问题。
" /><meta
  name="keywords"
  content="devbins, Emacs, ArchLinux"
/>


 


<meta
  name="generator"
  content="Hugo 0.114.1 with theme even"
/>


<link rel="canonical" href="http://devbins.github.io/post/leakcanary/" />
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png"> <link rel="icon" type="image/png"
sizes="16x16" href="../../favicon-16x16.png"> <link rel="manifest"
href="../../manifest.json"> <link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">



<link href="../../sass/main.min.b874a8796a492f0d7c86bb24c33cbf052935783a5778ebaf819a8e514bf49f10.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
 <meta property="og:title" content="LeakCanary 内存泄漏检测原理" />
<meta property="og:description" content="前言
内存泄漏是一个开发不得不面对的问题，在 Android 中有许多工具都可以用来检测内存泄漏，比如：MAT、Profile等。
但是这些工具都需要手动操作，比较麻烦，所以我们需要一个能够自动检测的工具，它就是LeakCanary。
今天就来了解一下原理，毕竟面试也是常问的问题。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://devbins.github.io/post/leakcanary/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-06T00:00:00+00:00" />
<meta itemprop="name" content="LeakCanary 内存泄漏检测原理">
<meta itemprop="description" content="前言
内存泄漏是一个开发不得不面对的问题，在 Android 中有许多工具都可以用来检测内存泄漏，比如：MAT、Profile等。
但是这些工具都需要手动操作，比较麻烦，所以我们需要一个能够自动检测的工具，它就是LeakCanary。
今天就来了解一下原理，毕竟面试也是常问的问题。"><meta itemprop="datePublished" content="2022-08-06T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-08-06T00:00:00+00:00" />
<meta itemprop="wordCount" content="2719">
<meta itemprop="keywords" content="Android," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="LeakCanary 内存泄漏检测原理"/>
<meta name="twitter:description" content="前言
内存泄漏是一个开发不得不面对的问题，在 Android 中有许多工具都可以用来检测内存泄漏，比如：MAT、Profile等。
但是这些工具都需要手动操作，比较麻烦，所以我们需要一个能够自动检测的工具，它就是LeakCanary。
今天就来了解一下原理，毕竟面试也是常问的问题。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script> <!
[endif]--> <!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script> <!
[endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="../../" class="logo">devbins</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="../../">
        <li class="mobile-menu-item">Home</li>
      </a><a href="../../post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="../../tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="../../categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="../../about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="../../" class="logo">devbins</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="../../">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">LeakCanary 内存泄漏检测原理</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-06 </span>
        <div class="post-category">
            <a href="../../categories/android/"> Android </a>
            </div>
          <span class="more-meta"> 约 2719 字 </span>
          <span class="more-meta"> 预计阅读 6 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#前置知识">前置知识</a></li>
    <li><a href="#activity泄漏检测">Activity泄漏检测</a></li>
    <li><a href="#检测时机">检测时机</a></li>
    <li><a href="#过滤一些系统内存泄漏">过滤一些系统内存泄漏</a></li>
    <li><a href="#自定义检测">自定义检测</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="前言">前言</h2>
<p>内存泄漏是一个开发不得不面对的问题，在 Android 中有许多工具都可以用来检测内存泄漏，比如：MAT、Profile等。</p>
<p>但是这些工具都需要手动操作，比较麻烦，所以我们需要一个能够自动检测的工具，它就是<a href="https://square.github.io/leakcanary/">LeakCanary</a>。</p>
<p>今天就来了解一下原理，毕竟面试也是常问的问题。</p>
<h2 id="前置知识">前置知识</h2>
<p>在学习之前，先来了解一下相关的知识。</p>
<p>内存泄漏：内存泄漏指的是该释放的内存没有被释放，导致可用内存减少，严重会引起内存溢出。</p>
<p>由于内存泄漏有可能会造成严重的后果，所以我们要对它进行检测，以便及时发现问题，排除隐患。</p>
<p>从内存泄漏的定义上可以知道，我们需要检测对象的释放，那要怎么检测对象有没有释放呢？</p>
<p>在 <code>Java</code> 中有四种引用，强引用、软引用、弱引用、虚引用四种。通常我们写的就是强引用。</p>
<p>检测对象的释放就要用到其中的弱引用。</p>
<p>弱引用的构造函数里可以传递一个 <code>ReferenceQueue</code> ，当弱引用的指向的对象被回收的时候，会把它放进 <code>ReferenceQueue</code> 中，所以依据这个我们就能实现内存泄漏的检测。</p>
<p>我们来写一个例子看看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.ref.ReferenceQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.ref.WeakReference</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">LeakDetect</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReferenceQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReferenceQueue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="n">Object</span><span class="o">(),</span> <span class="n">queue</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before gc: ref get: &#34;</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;, queue: &#34;</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">gc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after gc: ref get: &#34;</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;, queue: &#34;</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">before gc: ref get: java.lang.Object@2a139a55, queue: null
</span></span><span class="line"><span class="cl">after gc: ref get: null, queue: java.lang.ref.WeakReference@15db9742
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到 <code>Object</code> 被回收后会放到 <code>ReferenceQueue</code> 中，而原来的 <code>WeakReference</code> 中已经获取不到了。</p>
<p>接下来写一个内存泄漏的场景，让 <code>Object</code> 保持强引用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.ref.ReferenceQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.ref.WeakReference</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">LeakDetect</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReferenceQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReferenceQueue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;&gt;(</span><span class="n">obj</span><span class="o">,</span> <span class="n">queue</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before gc: ref get: &#34;</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;, queue: &#34;</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">gc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after gc: ref get: &#34;</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;, queue: &#34;</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">before gc: ref get: java.lang.Object@2a139a55, queue: null
</span></span><span class="line"><span class="cl">after gc: ref get: java.lang.Object@2a139a55, queue: null
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里 <code>obj</code> 由于一直持有强引用，所以在 <code>GC</code> 的时候并不会回收，所以通过 <code>WeakReference</code> 还是可以获取到，而 <code>ReferenceQueue</code> 里面则没有，所以这里就发生了泄漏。</p>
<h2 id="activity泄漏检测">Activity泄漏检测</h2>
<p>有了之前的知识做铺垫，就可以来看下 <code>LeakCanary</code> 是怎么实现内存泄漏检测的。我们以 <code>Activity</code> 的泄漏检测为例。</p>
<p>在 <code>Android</code> 中 <code>Activity</code> 的销毁时机我们是不太确定的，但是我们可以确定的是在 <code>Activity</code> 的生命周期结束的时候就认为 <code>Activity</code> 要被销毁掉，也就是在 <code>onDestroy</code> 调用的时候， <code>Activity</code> 应该就将要被回收了。</p>
<p><code>Android</code> 可以使用 <code>ActivityLifecycleCallbacks</code> 来监听所有 <code>Activity</code> 的回调，可以很方便的检测 <code>Activity</code> 的泄漏</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ActivityRefWatcher</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ActivityLifecycleCallbacks</span> <span class="n">lifecycleCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityLifecycleCallbacksAdapter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityDestroyed</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ActivityRefWatcher</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">refWatcher</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">install</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">RefWatcher</span> <span class="n">refWatcher</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Application</span> <span class="n">application</span> <span class="o">=</span> <span class="o">(</span><span class="n">Application</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ActivityRefWatcher</span> <span class="n">activityRefWatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityRefWatcher</span><span class="o">(</span><span class="n">application</span><span class="o">,</span> <span class="n">refWatcher</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">application</span><span class="o">.</span><span class="na">registerActivityLifecycleCallbacks</span><span class="o">(</span><span class="n">activityRefWatcher</span><span class="o">.</span><span class="na">lifecycleCallbacks</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>ActivityRefWatcher</code> 中把 <code>Activity</code> 的 <code>Destroy</code> 交给了 <code>RefWatcher</code> 的 <code>watch</code> 处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RefWatcher</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">retainedKeys</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ReferenceQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">watch</span><span class="o">(</span><span class="n">Object</span> <span class="n">watchedReference</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">watch</span><span class="o">(</span><span class="n">watchedReference</span><span class="o">,</span> <span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">watch</span><span class="o">(</span><span class="n">Object</span> <span class="n">watchedReference</span><span class="o">,</span> <span class="n">String</span> <span class="n">referenceName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">!=</span> <span class="n">DISABLED</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">watchStartNanoTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">retainedKeys</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">KeyedWeakReference</span> <span class="n">reference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KeyedWeakReference</span><span class="o">(</span><span class="n">watchedReference</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">referenceName</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">queue</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">ensureGoneAsync</span><span class="o">(</span><span class="n">watchStartNanoTime</span><span class="o">,</span> <span class="n">reference</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>watch</code> 中用 <code>UUID</code> 生成了一个随机字符串，然后把它放到了 <code>Set</code> 中，这样就可以把它和引用对象保持一个关联，相当于打了标签。使用 <code>UUID</code> 可以避免对象重复。</p>
<p>接着创建了 <code>KeyedWeakReference</code> ，它就是继承了 <code>WeakReference</code> 然后添加了 <code>key</code> 和 <code>name</code> 而已，如下所示。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">KeyedWeakReference</span> <span class="kd">extends</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">key</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">KeyedWeakReference</span><span class="o">(</span><span class="n">Object</span> <span class="n">referent</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">ReferenceQueue</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">referenceQueue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">checkNotNull</span><span class="o">(</span><span class="n">referent</span><span class="o">,</span> <span class="s">&#34;referent&#34;</span><span class="o">),</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">referenceQueue</span><span class="o">,</span> <span class="s">&#34;referenceQueue&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">&#34;key&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">&#34;name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>watch</code> 的最后调用了 <code>ensureGoneAsync</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">ensureGoneAsync</span><span class="o">(</span><span class="kd">final</span> <span class="kt">long</span> <span class="n">watchStartNanoTime</span><span class="o">,</span> <span class="kd">final</span> <span class="n">KeyedWeakReference</span> <span class="n">reference</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">watchExecutor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Retryable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Result</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">RefWatcher</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">ensureGone</span><span class="o">(</span><span class="n">reference</span><span class="o">,</span> <span class="n">watchStartNanoTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Result</span> <span class="nf">ensureGone</span><span class="o">(</span><span class="n">KeyedWeakReference</span> <span class="n">reference</span><span class="o">,</span> <span class="kt">long</span> <span class="n">watchStartNanoTime</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">gcStartNanoTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">watchDurationMs</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">gcStartNanoTime</span> <span class="o">-</span> <span class="n">watchStartNanoTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">removeWeaklyReachableReferences</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">debuggerControl</span><span class="o">.</span><span class="na">isDebuggerAttached</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">RETRY</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">gone</span><span class="o">(</span><span class="n">reference</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">DONE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">gcTrigger</span><span class="o">.</span><span class="na">runGc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">removeWeaklyReachableReferences</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">gone</span><span class="o">(</span><span class="n">reference</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">startDumpHeap</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">gcDurationMs</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">startDumpHeap</span> <span class="o">-</span> <span class="n">gcStartNanoTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">File</span> <span class="n">heapDumpFile</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">heapDumper</span><span class="o">.</span><span class="na">dumpHeap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">heapDumpFile</span> <span class="o">==</span> <span class="n">HeapDumper</span><span class="o">.</span><span class="na">RETRY_LATER</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">RETRY</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">heapDumpDurationMs</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">startDumpHeap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">HeapDump</span> <span class="n">heapDump</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">heapDumpBuilder</span><span class="o">.</span><span class="na">heapDumpFile</span><span class="o">(</span><span class="n">heapDumpFile</span><span class="o">).</span><span class="na">referenceKey</span><span class="o">(</span><span class="n">reference</span><span class="o">.</span><span class="na">key</span><span class="o">).</span><span class="na">referenceName</span><span class="o">(</span><span class="n">reference</span><span class="o">.</span><span class="na">name</span><span class="o">).</span><span class="na">watchDurationMs</span><span class="o">(</span><span class="n">watchDurationMs</span><span class="o">).</span><span class="na">gcDurationMs</span><span class="o">(</span><span class="n">gcDurationMs</span><span class="o">).</span><span class="na">heapDumpDurationMs</span><span class="o">(</span><span class="n">heapDumpDurationMs</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">heapdumpListener</span><span class="o">.</span><span class="na">analyze</span><span class="o">(</span><span class="n">heapDump</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">DONE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <code>ensureGone</code> 里会先调用 <code>removeWeaklyReachableReferences</code> 来把 <code>queue</code> 里的对象从 <code>Set</code> 中移除掉，根据前置知识我们知道这里的对象都是被释放掉的，所以在这里我们要从 <code>Set</code> 中移除掉对应的 <code>key</code> ，表示这个对象被释放了，没有泄漏。</p>
<p><code>removeWeaklyReachableReferences</code> 如下所示</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeWeaklyReachableReferences</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">KeyedWeakReference</span> <span class="n">ref</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="o">((</span><span class="n">ref</span> <span class="o">=</span> <span class="o">(</span><span class="n">KeyedWeakReference</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">retainedKeys</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着我们看 <code>gone</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">gone</span><span class="o">(</span><span class="n">KeyedWeakReference</span> <span class="n">reference</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">retainedKeys</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">reference</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的逻辑比较简单，如果 <code>retainedKeys</code> 这个 <code>Set</code> 中包含了 <code>KeyedWeakReference</code> 中的 <code>key</code> 说明就没有释放。如果不包含就说明释放了，也就是在上一步 <code>removeWeaklyReachableReferences</code> 会把释放的移除掉。</p>
<p>如果释放了就没有泄漏，直接返回。接着往下就是 <code>retainedKeys</code> 中还有对应的 <code>key</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">this</span><span class="o">.</span><span class="na">gcTrigger</span><span class="o">.</span><span class="na">runGc</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="k">this</span><span class="o">.</span><span class="na">removeWeaklyReachableReferences</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">gone</span><span class="o">(</span><span class="n">reference</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">startDumpHeap</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">gcDurationMs</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">startDumpHeap</span> <span class="o">-</span> <span class="n">gcStartNanoTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">File</span> <span class="n">heapDumpFile</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">heapDumper</span><span class="o">.</span><span class="na">dumpHeap</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">heapDumpFile</span> <span class="o">==</span> <span class="n">HeapDumper</span><span class="o">.</span><span class="na">RETRY_LATER</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">RETRY</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">heapDumpDurationMs</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">startDumpHeap</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">HeapDump</span> <span class="n">heapDump</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">heapDumpBuilder</span><span class="o">.</span><span class="na">heapDumpFile</span><span class="o">(</span><span class="n">heapDumpFile</span><span class="o">).</span><span class="na">referenceKey</span><span class="o">(</span><span class="n">reference</span><span class="o">.</span><span class="na">key</span><span class="o">).</span><span class="na">referenceName</span><span class="o">(</span><span class="n">reference</span><span class="o">.</span><span class="na">name</span><span class="o">).</span><span class="na">watchDurationMs</span><span class="o">(</span><span class="n">watchDurationMs</span><span class="o">).</span><span class="na">gcDurationMs</span><span class="o">(</span><span class="n">gcDurationMs</span><span class="o">).</span><span class="na">heapDumpDurationMs</span><span class="o">(</span><span class="n">heapDumpDurationMs</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">heapdumpListener</span><span class="o">.</span><span class="na">analyze</span><span class="o">(</span><span class="n">heapDump</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里会先触发一次 <code>GC</code> ，为了确保触发了 <code>GC</code> ，然后再次调用 <code>removeWeaklyReachableReferences</code> 来移除被回收的 <code>key</code> 。</p>
<p>如果这次 <code>key</code> 还存在就说明发生了泄漏。</p>
<p>接着就是把堆栈信息保存起来，生成泄漏报告到文件中。</p>
<h2 id="检测时机">检测时机</h2>
<p>在上一小结中当 <code>Activity</code> 的 <code>onDestory</code> 调用后会执行检测任务，而检测是会耗性能的，在主线程检测是有可能引发 <code>ANR</code> 的，所以我们来看看这里在什么时机进行检测的。</p>
<p>我们在源码中发现在 <code>watch</code> 方法中最后会调用 <code>ensureGoneAsync</code> ，从名字上看像是异步的，来具体看下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">WatchExecutor</span> <span class="n">watchExecutor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">ensureGoneAsync</span><span class="o">(</span><span class="kd">final</span> <span class="kt">long</span> <span class="n">watchStartNanoTime</span><span class="o">,</span> <span class="kd">final</span> <span class="n">KeyedWeakReference</span> <span class="n">reference</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">watchExecutor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Retryable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Result</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">RefWatcher</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">ensureGone</span><span class="o">(</span><span class="n">reference</span><span class="o">,</span> <span class="n">watchStartNanoTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里可以看到这里使用了 <code>watchExecutor</code> 来执行这个任务，而 <code>watchExecutor</code> 的类型是 <code>WatchExecutor</code> 是通过构造函数传进来的。</p>
<p>经过跟踪发现 <code>WatchExecutor</code> 是个接口，在 <code>Android</code> 的实现为 <code>AndroidWatchExecutor</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">AndroidWatchExecutor</span> <span class="kd">implements</span> <span class="n">WatchExecutor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Handler</span> <span class="n">mainHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Handler</span> <span class="n">backgroundHandler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AndroidWatchExecutor</span><span class="o">(</span><span class="kt">long</span> <span class="n">initialDelayMillis</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">HandlerThread</span> <span class="n">handlerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HandlerThread</span><span class="o">(</span><span class="s">&#34;LeakCanary-Heap-Dump&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">handlerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">backgroundHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">handlerThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Retryable</span> <span class="n">retryable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">().</span><span class="na">getThread</span><span class="o">()</span> <span class="o">==</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">waitForIdle</span><span class="o">(</span><span class="n">retryable</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">postWaitForIdle</span><span class="o">(</span><span class="n">retryable</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">postWaitForIdle</span><span class="o">(</span><span class="kd">final</span> <span class="n">Retryable</span> <span class="n">retryable</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">failedAttempts</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">mainHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AndroidWatchExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">waitForIdle</span><span class="o">(</span><span class="n">retryable</span><span class="o">,</span> <span class="n">failedAttempts</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">waitForIdle</span><span class="o">(</span><span class="kd">final</span> <span class="n">Retryable</span> <span class="n">retryable</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">failedAttempts</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Looper</span><span class="o">.</span><span class="na">myQueue</span><span class="o">().</span><span class="na">addIdleHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">IdleHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">queueIdle</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">AndroidWatchExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">postToBackgroundWithDelay</span><span class="o">(</span><span class="n">retryable</span><span class="o">,</span> <span class="n">failedAttempts</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">postToBackgroundWithDelay</span><span class="o">(</span><span class="kd">final</span> <span class="n">Retryable</span> <span class="n">retryable</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">failedAttempts</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">exponentialBackoffFactor</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span><span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="mf">2.0D</span><span class="o">,</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span><span class="n">failedAttempts</span><span class="o">),</span> <span class="o">(</span><span class="kt">double</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">maxBackoffFactor</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">delayMillis</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">initialDelayMillis</span> <span class="o">*</span> <span class="n">exponentialBackoffFactor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">backgroundHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="n">retryable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">Result</span><span class="o">.</span><span class="na">RETRY</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">AndroidWatchExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">postWaitForIdle</span><span class="o">(</span><span class="n">retryable</span><span class="o">,</span> <span class="n">failedAttempts</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span> <span class="n">delayMillis</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到在 <code>execute</code> 中会最终调用 <code>waitForIdle</code> ，在这里会调用主线程的 <code>addIdleHandler</code> ，只有在主线程空闲的时间才会执行，避免与主线程抢占 <code>CPU</code> 资源。</p>
<p>然后在 <code>queueIdld</code> 中又把任务提交到了自己创建的 <code>HandlerThread</code> 线程中去执行，这样就不会导致主线程 <code>ANR</code> 。</p>
<h2 id="过滤一些系统内存泄漏">过滤一些系统内存泄漏</h2>
<p>我们的系统自身也可能存在泄漏的情况，这些就不是开发者能够控制的，所以我们要把这些情况排除在外， <code>LeakCanary</code> 也考虑到了，值的我们借鉴和学习</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">LeakCanary</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">RefWatcher</span> <span class="nf">install</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Application</span> <span class="n">application</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">((</span><span class="n">AndroidRefWatcherBuilder</span><span class="o">)</span><span class="n">refWatcher</span><span class="o">(</span><span class="n">application</span><span class="o">).</span><span class="na">listenerServiceClass</span><span class="o">(</span><span class="n">DisplayLeakService</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">excludedRefs</span><span class="o">(</span><span class="n">AndroidExcludedRefs</span><span class="o">.</span><span class="na">createAppDefaults</span><span class="o">().</span><span class="na">build</span><span class="o">())).</span><span class="na">buildAndInstall</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里调用了 <code>excludedRefs</code> 把一些常见的场景给排除在外了。</p>
<p>它们定义在 <code>AndroidExcludedRefs</code> 来看一些例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">AndroidExcludedRefs</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ACTIVITY_CLIENT_RECORD__NEXT_IDLE</span><span class="o">(</span><span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="mi">19</span> <span class="o">&amp;&amp;</span> <span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&lt;=</span> <span class="mi">21</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Builder</span> <span class="n">excluded</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">excluded</span><span class="o">.</span><span class="na">instanceField</span><span class="o">(</span><span class="s">&#34;android.app.ActivityThread$ActivityClientRecord&#34;</span><span class="o">,</span> <span class="s">&#34;nextIdle&#34;</span><span class="o">).</span><span class="na">reason</span><span class="o">(</span><span class="s">&#34;Android AOSP sometimes keeps a reference to a destroyed activity as a nextIdle client record in the android.app.ActivityThread.mActivities map. Not sure what&#39;s going on there, input welcome.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span>
</span></span><span class="line"><span class="cl">    <span class="n">SPAN_CONTROLLER</span><span class="o">(</span><span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&lt;=</span> <span class="mi">19</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">Builder</span> <span class="n">excluded</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">String</span> <span class="n">reason</span> <span class="o">=</span> <span class="s">&#34;Editor inserts a special span, which has a reference to the EditText. That span is a NoCopySpan, which makes sure it gets dropped when creating a new SpannableStringBuilder from a given CharSequence. TextView.onSaveInstanceState() does a copy of its mText before saving it in the bundle. Prior to KitKat, that copy was done using the SpannableString constructor, instead of SpannableStringBuilder. The SpannableString constructor does not drop NoCopySpan spans. So we end up with a saved state that holds a reference to the textview and therefore the entire view hierarchy &amp; activity context. Fix: https://github.com/android/platform_frameworks_base/commit/af7dcdf35a37d7a7dbaad7d9869c1c91bce2272b . To fix this, you could override TextView.onSaveInstanceState(), and then use reflection to access TextView.SavedState.mText and clear the NoCopySpan spans.&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">excluded</span><span class="o">.</span><span class="na">instanceField</span><span class="o">(</span><span class="s">&#34;android.widget.Editor$EasyEditSpanController&#34;</span><span class="o">,</span> <span class="s">&#34;this$0&#34;</span><span class="o">).</span><span class="na">reason</span><span class="o">(</span><span class="n">reason</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">excluded</span><span class="o">.</span><span class="na">instanceField</span><span class="o">(</span><span class="s">&#34;android.widget.Editor$SpanController&#34;</span><span class="o">,</span> <span class="s">&#34;this$0&#34;</span><span class="o">).</span><span class="na">reason</span><span class="o">(</span><span class="n">reason</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="自定义检测">自定义检测</h2>
<p><code>LeakCanary</code> 帮我们处理了常见的情况，如果我们想要自己检测一些类有没有泄漏该怎么做？</p>
<p>根据上面的分析 <code>watch</code> 中传入的是个 <code>Object</code> ，所以我们把要检测的对象传给 <code>watch</code> 方法就行了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RefWatcher</span> <span class="n">refWatcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">refWatcher</span> <span class="o">=</span> <span class="n">LeakCanary</span><span class="o">.</span><span class="na">install</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">RefWatcher</span> <span class="nf">getRefWatcher</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">refWatcher</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着调用 <code>watch</code> 方法就行了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">((</span><span class="n">App</span><span class="o">)</span><span class="n">getApplication</span><span class="o">()).</span><span class="na">getRefWatcher</span><span class="o">().</span><span class="na">watch</span><span class="o">(</span><span class="k">new</span> <span class="n">Object</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结</h2>
<p>可以看到使用 <code>LeakCanary</code> 还是非常简单的，比 <code>MAT</code> 、 <code>Profile</code> 这种手动的方式简单了许多。</p>
<p>内存泄漏检测的原理还是比较简单的，没了解之前以为很难，被自己吓到了。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=67&amp;sid=20-h5Url-0&amp;buyFrom=2&amp;pageId=1pz4#/detail/pc?id=1880">Android 工程师进阶 34 讲 - 前 360 技术专家</a></li>
<li><a href="https://blog.csdn.net/noblef/article/details/108975861">LeakCanary原理及使用_CassieW的博客-CSDN博客_leakcanary</a></li>
</ul>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">devbins</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2022-08-06
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="../../tags/android/">Android</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="../../post/c_mem_leak/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">C/C&#43;&#43; 内存泄漏检测</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="../../post/jnicache/">
            <span class="next-text nav-default">性能提高之JNI 缓存</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2022-08-06 00:00:00 \u002b0000 UTC',
        title: 'LeakCanary 内存泄漏检测原理',
        clientID: '1234e4dd9e0ad49470be',
        clientSecret: '9acb7351fca3dcca6d3cc50be8a1d2cf329f4163',
        repo: 'devbins.github.io',
        owner: 'devbins',
        admin: ['devbins'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a
    href="binshengh@gmail.com"
    class="iconfont icon-email"
    title="email"
  ></a>
  <a
    href="https://github.com/devbins"
    class="iconfont icon-github"
    title="github"
  ></a> 
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io"
      >Hugo</a
    > 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even"
      >Even</a
    >
  </span>

  

  <span class="copyright-year"> &copy; 2016 - 2023<span class="heart"><i class="iconfont icon-heart"></i></span
    ><span
      >devbins</span
    >
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="../../js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
