<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Zygote 是怎么使用 LocalSocket 进行进程间通信的 - devbins blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="devbins" /><meta name="description" content="前言 本文基于 Android10 ，分析 Zygote 与 AMS 是如何使用 LocalSocket 建立连接的。
" /><meta name="keywords" content="devbins, Emacs, ArchLinux" />






<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="http://devbins.github.io/post/localsocket/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.b874a8796a492f0d7c86bb24c33cbf052935783a5778ebaf819a8e514bf49f10.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Zygote 是怎么使用 LocalSocket 进行进程间通信的" />
<meta property="og:description" content="前言
本文基于 Android10 ，分析 Zygote 与 AMS 是如何使用 LocalSocket 建立连接的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://devbins.github.io/post/localsocket/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-03-26T00:00:00&#43;08:00" />
<meta property="article:modified_time" content="2021-03-26T00:00:00&#43;08:00" />

<meta itemprop="name" content="Zygote 是怎么使用 LocalSocket 进行进程间通信的">
<meta itemprop="description" content="前言
本文基于 Android10 ，分析 Zygote 与 AMS 是如何使用 LocalSocket 建立连接的。"><meta itemprop="datePublished" content="2021-03-26T00:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2021-03-26T00:00:00&#43;08:00" />
<meta itemprop="wordCount" content="2544">
<meta itemprop="keywords" content="Android,Framework,LocalSocket," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Zygote 是怎么使用 LocalSocket 进行进程间通信的"/>
<meta name="twitter:description" content="前言
本文基于 Android10 ，分析 Zygote 与 AMS 是如何使用 LocalSocket 建立连接的。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">devbins</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">devbins</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Zygote 是怎么使用 LocalSocket 进行进程间通信的</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-03-26 </span>
        <div class="post-category">
            <a href="/categories/android/"> Android </a>
            </div>
          <span class="more-meta"> 约 2544 字 </span>
          <span class="more-meta"> 预计阅读 6 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#server">Server</a></li>
    <li><a href="#client">Client</a></li>
    <li><a href="#服务端和客户端是怎么关联上的">服务端和客户端是怎么关联上的</a></li>
    <li><a href="#回到-socket-创建的地方">回到 Socket 创建的地方</a></li>
    <li><a href="#init-进程">init 进程</a>
      <ul>
        <li><a href="#环境变量的赋值">环境变量的赋值</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="前言">前言</h2>
<p>本文基于 <code>Android10</code> ，分析 <code>Zygote</code> 与 <code>AMS</code> 是如何使用 <code>LocalSocket</code> 建立连接的。</p>
<h2 id="server">Server</h2>
<p>我们先来看服务端，了解 <code>Zygote</code> 的都知道， <code>Zygote</code> 会创建一个 <code>ServerSocket</code> 用来等待 <code>AMS</code> 发起创建新应用的请求，我们就从这里开始看起
<code>/frameworks/base/core/java/com/android/internal/os/Zygote.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ANDROID_SOCKET_PREFIX</span> <span class="o">=</span> <span class="s">&#34;ANDROID_SOCKET_&#34;</span><span class="o">;</span>

<span class="kd">static</span> <span class="n">LocalServerSocket</span> <span class="nf">createManagedSocketFromInitSocket</span><span class="o">(</span><span class="n">String</span> <span class="n">socketName</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">fileDesc</span><span class="o">;</span>
    <span class="c1">// fullSocketName = ANDROID_SOCKET_zygote
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">String</span> <span class="n">fullSocketName</span> <span class="o">=</span> <span class="n">ANDROID_SOCKET_PREFIX</span> <span class="o">+</span> <span class="n">socketName</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 从环境变量中读取 ANDROID_SOCKET_zygote
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">env</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="n">fullSocketName</span><span class="o">);</span>
        <span class="c1">// 转为int ，也就是文件描述符id
</span><span class="c1"></span>        <span class="n">fileDesc</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&#34;Socket unset or invalid: &#34;</span> <span class="o">+</span> <span class="n">fullSocketName</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 创建文件描述符，并用它创建 LocalServerSocket
</span><span class="c1"></span>        <span class="n">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileDescriptor</span><span class="o">();</span>
        <span class="c1">// 使用环境变量中读取的值进行赋值
</span><span class="c1"></span>        <span class="n">fd</span><span class="o">.</span><span class="na">setInt$</span><span class="o">(</span><span class="n">fileDesc</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">LocalServerSocket</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span>
            <span class="s">&#34;Error building socket from file descriptor: &#34;</span> <span class="o">+</span> <span class="n">fileDesc</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>fullSocketName</code> 是 <code>ANDROID_SOCKET_zygote</code> ，接着从环境变量中读取这个值。然后转为 <code>int</code> 并用它来创建文件描述符。</p>
<p>然后用创建好的文件描述符创建 <code>LocalServerSocket</code> ，到此服务端就准备好了。</p>
<h2 id="client">Client</h2>
<p>服务端创建好之后，我们来看 <code>AMS</code> 是怎么连接上服务端的，我们直接来看客户端的创建，经过一系列跟踪定位到 <code>ZygoteProcess.attemptConnectionToPrimaryZygote</code> 方法
<code>/frameworks/base/core/java/android/os/ZygoteProcess.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 以下内容来自/frameworks/base/core/java/com/android/internal/os/Zygote.java
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PRIMARY_SOCKET_NAME</span> <span class="o">=</span> <span class="s">&#34;zygote&#34;</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SECONDARY_SOCKET_NAME</span> <span class="o">=</span> <span class="s">&#34;zygote_secondary&#34;</span><span class="o">;</span>
<span class="c1">// ---------------------
</span><span class="c1"></span>
<span class="kd">public</span> <span class="nf">ZygoteProcess</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 用 zygote 创建 LocalSocketAddress
</span><span class="c1"></span>    <span class="n">mZygoteSocketAddress</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">LocalSocketAddress</span><span class="o">(</span><span class="n">Zygote</span><span class="o">.</span><span class="na">PRIMARY_SOCKET_NAME</span><span class="o">,</span>
                               <span class="n">LocalSocketAddress</span><span class="o">.</span><span class="na">Namespace</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">);</span>
    <span class="n">mZygoteSecondarySocketAddress</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">LocalSocketAddress</span><span class="o">(</span><span class="n">Zygote</span><span class="o">.</span><span class="na">SECONDARY_SOCKET_NAME</span><span class="o">,</span>
                               <span class="n">LocalSocketAddress</span><span class="o">.</span><span class="na">Namespace</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">);</span>

    <span class="n">mUsapPoolSocketAddress</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">LocalSocketAddress</span><span class="o">(</span><span class="n">Zygote</span><span class="o">.</span><span class="na">USAP_POOL_PRIMARY_SOCKET_NAME</span><span class="o">,</span>
                               <span class="n">LocalSocketAddress</span><span class="o">.</span><span class="na">Namespace</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">);</span>
    <span class="n">mUsapPoolSecondarySocketAddress</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">LocalSocketAddress</span><span class="o">(</span><span class="n">Zygote</span><span class="o">.</span><span class="na">USAP_POOL_SECONDARY_SOCKET_NAME</span><span class="o">,</span>
                               <span class="n">LocalSocketAddress</span><span class="o">.</span><span class="na">Namespace</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">attemptConnectionToPrimaryZygote</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">primaryZygoteState</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">primaryZygoteState</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">primaryZygoteState</span> <span class="o">=</span>
            <span class="n">ZygoteState</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">mZygoteSocketAddress</span><span class="o">,</span> <span class="n">mUsapPoolSocketAddress</span><span class="o">);</span>

        <span class="n">maybeSetApiBlacklistExemptions</span><span class="o">(</span><span class="n">primaryZygoteState</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">maybeSetHiddenApiAccessLogSampleRate</span><span class="o">(</span><span class="n">primaryZygoteState</span><span class="o">);</span>
        <span class="n">maybeSetHiddenApiAccessStatslogSampleRate</span><span class="o">(</span><span class="n">primaryZygoteState</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>mZygoteSocketAddress</code> 是在构造方法中创建的，它使用字符串 <code>zygote</code> 创建 <code>LocalSocketAddress</code> ，紧接着调用了 <code>ZygoteState.connect</code></p>
<p><code>/frameworks/base/core/java/android/os/ZygoteProcess.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="n">ZygoteState</span> <span class="nf">connect</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">LocalSocketAddress</span> <span class="n">zygoteSocketAddress</span><span class="o">,</span>
                           <span class="nd">@Nullable</span> <span class="n">LocalSocketAddress</span> <span class="n">usapSocketAddress</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

    <span class="n">DataInputStream</span> <span class="n">zygoteInputStream</span><span class="o">;</span>
    <span class="n">BufferedWriter</span> <span class="n">zygoteOutputWriter</span><span class="o">;</span>
    <span class="c1">// 创建客户端 LocalSocket
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">LocalSocket</span> <span class="n">zygoteSessionSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalSocket</span><span class="o">();</span>

    <span class="c1">// 使用上一步创建的 LocalSocketAddress 连接服务端
</span><span class="c1"></span>    <span class="n">zygoteSessionSocket</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">zygoteSocketAddress</span><span class="o">);</span>
    <span class="n">zygoteInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">zygoteSessionSocket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
    <span class="n">zygoteOutputWriter</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">OutputStreamWriter</span><span class="o">(</span><span class="n">zygoteSessionSocket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()),</span>
            <span class="n">Zygote</span><span class="o">.</span><span class="na">SOCKET_BUFFER_SIZE</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">ZygoteState</span><span class="o">(</span><span class="n">zygoteSocketAddress</span><span class="o">,</span> <span class="n">usapSocketAddress</span><span class="o">,</span>
                                   <span class="n">zygoteSessionSocket</span><span class="o">,</span> <span class="n">zygoteInputStream</span><span class="o">,</span> <span class="n">zygoteOutputWriter</span><span class="o">,</span>
                                   <span class="n">getAbiList</span><span class="o">(</span><span class="n">zygoteOutputWriter</span><span class="o">,</span> <span class="n">zygoteInputStream</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在这里创建了客户端 <code>LocalSocket</code> ，然后调用 <code>connect</code> 和上一步创建的 <code>LocalSocketAddress</code> 进行连接。</p>
<p>在服务端创建的过程中，服务端使用的是文件描述符来创建 <code>LocalServerSocket</code> 的，而在客户端使用的是 <code>LocalSocketAddress</code> ，并且用的是字符串 <code>zygote</code> 来初始化。</p>
<p>那么问题来了，文件描述符是怎么和 <code>LocalSocketAddress(&quot;zygote&quot;)</code> 关联上的？</p>
<h2 id="服务端和客户端是怎么关联上的">服务端和客户端是怎么关联上的</h2>
<p>起初我以为答案在 <code>LocalSocketAddress</code> 中，一直追踪源码，发现 <code>LocalSocketAddress</code> 里面就只是保存了 <code>name</code> 和 <code>namespace</code> 而已，什么也没做。</p>
<p>所以我就猜测答案可能在 <code>connect</code> 中</p>
<p><code>/frameworks/base/core/java/android/net/LocalSocket.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="n">LocalSocketAddress</span> <span class="n">endpoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isConnected</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;already connected&#34;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">implCreateIfNeeded</span><span class="o">();</span>
        <span class="n">impl</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">endpoint</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="n">isConnected</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">isBound</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <code>implCreateIfNeeded</code> 中创建了 <code>LocalSocketImpl</code> 然后把连接任务交给了它。
<code>/frameworks/base/core/java/android/net/LocalSocketImpl.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">connectLocal</span><span class="o">(</span><span class="n">FileDescriptor</span> <span class="n">fd</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">namespace</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>

<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="n">LocalSocketAddress</span> <span class="n">address</span><span class="o">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="o">)</span>
                        <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;socket not created&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">connectLocal</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="n">address</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">address</span><span class="o">.</span><span class="na">getNamespace</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>发现 <code>connect</code> 去调用 <code>connectLocal</code> ，它是个本地方法，也没发现它们有什么关联。不过这里却出现了 <code>FileDescriptor</code> ，只要找到它在哪里赋值的，答案是不是就可以揭晓了？</p>
<p>我怀着激动的心情找到 <code>fd</code> 赋值的地方，发现有两处地方，如下所示
<code>/frameworks/base/core/java/android/net/LocalSocketImpl.java</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">LocalSocketImpl</span><span class="o">(</span><span class="n">FileDescriptor</span> <span class="n">fd</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="kt">int</span> <span class="n">sockType</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&#34;LocalSocketImpl already has an fd&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">osType</span><span class="o">;</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">sockType</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">LocalSocket</span><span class="o">.</span><span class="na">SOCKET_DGRAM</span><span class="o">:</span>
        <span class="n">osType</span> <span class="o">=</span> <span class="n">OsConstants</span><span class="o">.</span><span class="na">SOCK_DGRAM</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="k">case</span> <span class="n">LocalSocket</span><span class="o">.</span><span class="na">SOCKET_STREAM</span><span class="o">:</span>
        <span class="n">osType</span> <span class="o">=</span> <span class="n">OsConstants</span><span class="o">.</span><span class="na">SOCK_STREAM</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="k">case</span> <span class="n">LocalSocket</span><span class="o">.</span><span class="na">SOCKET_SEQPACKET</span><span class="o">:</span>
        <span class="n">osType</span> <span class="o">=</span> <span class="n">OsConstants</span><span class="o">.</span><span class="na">SOCK_SEQPACKET</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;unknown sockType&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">Os</span><span class="o">.</span><span class="na">socket</span><span class="o">(</span><span class="n">OsConstants</span><span class="o">.</span><span class="na">AF_UNIX</span><span class="o">,</span> <span class="n">osType</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="n">mFdCreatedInternally</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ErrnoException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">rethrowAsIOException</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>第一处在构造方法中，显然不是我们要的，因为客户端使用的是字符串创建的 <code>LocalSocketAddress</code> 。</p>
<p>剩下就只有 <code>create</code> 方法了，在这个方法中使用 <code>Os.socket</code> 创建了 <code>fd</code> ，这是客户端的描述符，也没有和字符串 <code>zygote</code> 关联上，回顾一下服务端使用的是环境变量中的值来创建的 <code>FileDescriptor</code> ，这里的参数列表是 <code>FileDescriptor socket (int domain, int type, int protocol)</code> ，和 <code>zygote</code> 没关系，线索到这突然就断了。</p>
<p>既然客户端看不出 <code>zygote</code> 是怎么和 <code>FileDescriptor</code> 关联上的，我们就从服务端入手，看看能不能找到答案。</p>
<p>经过一通搜索和排查，发现和客户端一样，就是没有找到 <code>FileDescriptor</code> 和 <code>zygote</code> 关联上的地方。</p>
<h2 id="回到-socket-创建的地方">回到 Socket 创建的地方</h2>
<p>在服务端和客户端都没有找到答案，不过我在服务端发现一个有意思的地方，一直被我忽略了。就是在服务端创建 <code>FileDescriptor</code> 的时候从环境变量获取到 <code>ANDROID_SOCKET_zygote</code> 的值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">String</span> <span class="n">fullSocketName</span> <span class="o">=</span> <span class="n">ANDROID_SOCKET_PREFIX</span> <span class="o">+</span> <span class="n">socketName</span><span class="o">;</span>
<span class="c1">// 从环境变量中读取 ANDROID_SOCKET_zygote
</span><span class="c1"></span><span class="n">String</span> <span class="n">env</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="n">fullSocketName</span><span class="o">);</span>
<span class="c1">// 转为int ，也就是文件描述符id
</span><span class="c1"></span><span class="n">fileDesc</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
<span class="c1">// 创建文件描述符，并用它创建 LocalServerSocket
</span><span class="c1"></span><span class="n">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileDescriptor</span><span class="o">();</span>
<span class="n">fd</span><span class="o">.</span><span class="na">setInt$</span><span class="o">(</span><span class="n">fileDesc</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>看来 <code>ANDROID_SOCKET_zygote</code> 这个环境变量是突破的关键，但是它是在哪里赋值的呢？</p>
<h2 id="init-进程">init 进程</h2>
<p>我们回到 <code>init</code> 进程中看 <code>Zygote</code> 进程都有哪些配置
<code>/system/core/rootdir/init.zygote64.rc</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server
    class main
    socket zygote stream <span class="m">660</span> root system
    ...
</code></pre></td></tr></table>
</div>
</div><p>目光放到最后一行，这里配置了创建一个名为 <code>zygote</code> 的 <code>socket</code> ，原来 <code>Zygote</code> 中的 <code>Socket</code> 并不是 <code>Zygote</code> 创建的，而是 <code>init</code> 进程创建的。</p>
<p>这样就能说的通了，客户端创建 <code>LocalSocketAddress</code> 使用 <code>zygote</code> 作为参数，就能连到这个 <code>socket</code> 上。</p>
<p>那么服务端获取的 <code>ANDROID_SOCKET_zygote</code> 的值又是怎么告诉 <code>Zygote</code> 进程的呢？从上面的分析来看，通过环境变量来实现的。</p>
<h3 id="环境变量的赋值">环境变量的赋值</h3>
<p><code>/system/core/init/service.cpp</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="n">Result</span><span class="o">&lt;</span><span class="n">Success</span><span class="o">&gt;</span> <span class="n">Service</span><span class="o">::</span><span class="n">AddDescriptor</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">strtoul</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">c_str</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">Result</span><span class="o">&lt;</span><span class="n">uid_t</span><span class="o">&gt;</span> <span class="n">uid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">Result</span><span class="o">&lt;</span><span class="n">gid_t</span><span class="o">&gt;</span> <span class="n">gid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">context</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="o">?</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="p">;</span>

    <span class="c1">// ...
</span><span class="c1"></span>
    <span class="k">auto</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">*</span><span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="n">gid</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>

    <span class="k">auto</span> <span class="n">old</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">descriptors_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">descriptors_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                     <span class="p">[</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">]</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">descriptor</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">descriptors_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">Error</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;duplicate descriptor &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="n">descriptors_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">descriptor</span><span class="p">));</span>
    <span class="k">return</span> <span class="nf">Success</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// 判断 Socket 符不符合条件
</span><span class="c1"></span><span class="n">Result</span><span class="o">&lt;</span><span class="n">Success</span><span class="o">&gt;</span> <span class="n">Service</span><span class="o">::</span><span class="n">ParseSocket</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&#34;dgram&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&#34;stream&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&#34;seqpacket&#34;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">Error</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;socket type must be &#39;dgram&#39;, &#39;stream&#39; or &#39;seqpacket&#39;&#34;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 添加到列表中
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">AddDescriptor</span><span class="o">&lt;</span><span class="n">SocketInfo</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">Result</span><span class="o">&lt;</span><span class="n">Success</span><span class="o">&gt;</span> <span class="n">Service</span><span class="o">::</span><span class="n">Start</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">namespace_flags_</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">namespace_flags_</span> <span class="o">|</span> <span class="n">SIGCHLD</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">umask</span><span class="p">(</span><span class="mo">077</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">EnterNamespaces</span><span class="p">();</span> <span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Service &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; could not enter namespaces: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// 遍历每个 descriptor 调用 CreateAndPublish 方法
</span><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">descriptors_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">descriptors_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                      <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DescriptorInfo</span><span class="o">::</span><span class="n">CreateAndPublish</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">,</span> <span class="n">scon</span><span class="p">));</span>

        <span class="n">_exit</span><span class="p">(</span><span class="mi">127</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">Success</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>init</code> 进程在解析 <code>/system/core/rootdir/init.zygote64.rc</code> 文件时，解析 <code>socket</code> 会调用 <code>ParseSocket</code> ，在 <code>ParseSocket</code> 中会调用 <code>AddDescriptor</code> 把解析的参数保存到 <code>descriptors</code> ，然后在 <code>start</code> 方法中遍历 <code>descriptors</code> ，调用 <code>DescriptorInfo::CreateAndPublish</code> 方法创建 <code>Socket</code> 并且设置环境变量。</p>
<h4 id="createandpublish">CreateAndPublish</h4>
<p><code>/system/core/init/descriptors.cpp</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// 以下两个宏定义来自 /system/core/libcutils/include/cutils/sockets.h
</span><span class="c1"></span><span class="cp">#define ANDROID_SOCKET_ENV_PREFIX	&#34;ANDROID_SOCKET_&#34;
</span><span class="cp">#define ANDROID_SOCKET_DIR		&#34;/dev/socket&#34;
</span><span class="cp"></span><span class="c1">// ---------------------------------------
</span><span class="c1"></span>
<span class="n">DescriptorInfo</span><span class="o">::</span><span class="n">DescriptorInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span>
                               <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">perm</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">context</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">name_</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">type_</span><span class="p">(</span><span class="n">type</span><span class="p">),</span> <span class="n">uid_</span><span class="p">(</span><span class="n">uid</span><span class="p">),</span> <span class="n">gid_</span><span class="p">(</span><span class="n">gid</span><span class="p">),</span> <span class="n">perm_</span><span class="p">(</span><span class="n">perm</span><span class="p">),</span> <span class="n">context_</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">SocketInfo</span><span class="o">::</span><span class="n">key</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ANDROID_SOCKET_ENV_PREFIX</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">DescriptorInfo</span><span class="o">::</span><span class="n">CreateAndPublish</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">globalContext</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">contextStr</span> <span class="o">=</span> <span class="n">context_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="nl">globalContext</span> <span class="p">:</span> <span class="n">context_</span><span class="p">;</span>
    <span class="c1">// 创建 Socket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">Create</span><span class="p">(</span><span class="n">contextStr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// key 就是 ANDROID_SOCKET_zygote, name 就是 init.rc 中配置的 zygote
</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">publishedName</span> <span class="o">=</span> <span class="n">key</span><span class="p">()</span> <span class="o">+</span> <span class="n">name_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">publishedName</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">publishedName</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                  <span class="p">[]</span> <span class="p">(</span><span class="kt">char</span><span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> <span class="n">c</span> <span class="o">=</span> <span class="n">isalnum</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">?</span> <span class="nl">c</span> <span class="p">:</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span> <span class="p">});</span>

    <span class="c1">// 把 fd 转成字符串
</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">val</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="c1">// 设置环境变量
</span><span class="c1"></span>    <span class="n">setenv</span><span class="p">(</span><span class="n">publishedName</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">val</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <code>CreateAndPublish</code> 中先创建了 <code>socket</code> 然后调用 <code>setenv</code> 设置环境变量。至此我们就可以明白了 <code>AMS</code> 中的客户端是怎么连上 <code>Zygote</code> 中的服务端了。</p>
<p>根据这个发现，环境变量其实也能够用于进程间通信。</p>
<h2 id="总结">总结</h2>
<ol>
<li><code>zygote.rc</code> 文件中配置了需要创建一个名为 <code>zygote</code> 的 <code>socket</code></li>
<li><code>init</code> 进程在解析 <code>zygote.rc</code> 文件时会根据配置中的参数创建一个 <code>socket</code> 并把对应的描述符通过环境变量的方式公布出去。</li>
<li><code>Zygote</code> 进程会从环境变量中读取 <code>init</code> 进程创建 <code>socket</code> 时所设置的环境变量，用于创建 <code>LocalServerSocket</code></li>
<li><code>AMS</code> 在发起创建应用程序的请求时，会使用 <code>zygote</code> 这个字符串创建 <code>LocalSocket</code></li>
<li>由于服务端使用到的文件描述符的 <code>id</code> 和客户端使用到 <code>zygote</code> 表示的是同一个 <code>socket</code> ，所以客户端之间能够相互通通信。</li>
</ol>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://blog.csdn.net/qq%5F33859911/article/details/90905503">深入理解AMS之应用进程创建_乌啼夜的酒痕-CSDN博客</a></li>
<li><a href="http://gityuan.com/2016/03/26/app-process-create/">理解Android进程创建流程 - Gityuan博客 | 袁辉辉的技术博客</a></li>
<li><a href="http://gityuan.com/2016/02/05/android-init/">Android系统启动-Init篇 - Gityuan博客 | 袁辉辉的技术博客</a></li>
<li>《深入理解Android卷I》</li>
</ul>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">devbins</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-03-26
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/android/">Android</a>
          <a href="/tags/framework/">Framework</a>
          <a href="/tags/localsocket/">LocalSocket</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/jni%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">JNI中的引用</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/zygote/">
            <span class="next-text nav-default">Zygote</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="binshengh@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/devbins" class="iconfont icon-github" title="github"></a>
  <a href="http://devbins.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>devbins</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
